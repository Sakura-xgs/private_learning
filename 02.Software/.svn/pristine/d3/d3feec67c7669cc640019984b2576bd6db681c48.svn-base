/*
 * hal_adc.c
 *
 *  Created on: 2024年12月16日
 *      Author: Bono
 */
#include "hal_adc.h"

#define SEQ_RISING        0        //升序
#define SEQ_LOWER         1        //降序

#define TEMP_TABLE_SIZE_3380   (sizeof(TempCoffAdTable_3380)/sizeof(U16))
#define TEMP_TABLE_SIZE_3435   (sizeof(TempCoffAdTable_3435)/sizeof(U16))
#define TEMP_TABLE_SIZE_PT1000 (sizeof(R_Table)/sizeof(U16))

/*----------------------------------/NTC温度系数表/----------------------------------------*/
/* PT1000 */
static U16 R_Table[] =
{
	767,771,775,779,783,787,791,795,799,803,	//-50
	807,811,815,819,823,827,821,835,839,843,	//-40
	847,851,855,859,862,866,870,874,878,882,	//-30
	886,890,894,898,902,906,910,914,918,922,	//-20
	926,929,933,937,941,945,949,953,957,961,	//-10
	965,969,973,977,980,984,988,992,996,1000,	//0
	1004,1008,1012,1016,1020,1023,1027,1031,1035,// 10
	1039,1043,1047,1051,1055,1058,1062,1066,1070,1074,// 20
	1078,1082,1086,1090,1093,1097,1101,1105,1109,1113,//30
	1117,1121,1124,1128,1132,1136,1140,1144,1148,1152,//40
	1155,1159,1163,1167,1171,1175,1179,1182,1186,1190,//50
	1194,1198,1202,1206,1209,1213,1217,1221,1225,1229,//50
	1232,1236,1240,1244,1248,1252,1255,1259,1263,1267,//60
	1271,1275,1278,1282,1286,1290,1294,1298,1301,1305,//70
	1309,1313,1317,1320,1324,1328,1332,1337,1339,1343,//80
	1347,1351,1355,1358,1362,1366,1370,1374,1377,1381,//90
	1385,1389,1393,1396,1400,1404,1408,1412,1415,1419,//100
	1423,1427,1430,1434,1438,1442,1446,1449,1453,1457,//110
	1461,1464,1468,1472,1476,1480,1483,1487,1491,1495,//120
	1498,1502,1506,1510,1513,1517,1521,1525,1529,1531,//130
	1536,1540,1543,1547,1551,1555,1558,1562,1566,1570,//140
	1573,1577,1581,1584,1588,1592,1596,1599,1603,1607,//150
	1611,1614,1618,1622,1625,1629,1633,1637,1640,1644,//160
	1648,1651,1655,1659,1663,1666,1670,1674,1677,1681,//170
	1685,1688,1692,1696,1670,1703,1707,1711,1714,1718,//180
	1722,1725,1729,1733,1736,1740,1744,1748,1751,1755,//190
	1759,1762,1766,1770,1773,1777,1781,1784,1788,1792,//200
	1795,1799,1803,1806,1810,1814,1817,1821,1825,1828,//210
	1832,1836,1839,1843,1846,1850,1854,1857,1861,1865,//220
	1868,1872,1876,1879,1883,1887,1890,1894,1897,1901,//230
	1905,1908,1912,1916,1919,1923,1926,1930,1934,1937,//240
	1941,1945,1948,1952,1955,1959,1963,1966,1970,1974,//250
	1977,1981,1984,1988,1992,1995,1999,2002,2006,2010,//260
	2013,2017,2020,2024,2028,2031,2035,2038,2042,2045,//270
	2049,2053,2056,2060,2063,2067,2071,2074,2078,2081,//280
	2085,2088,2092,2096,2099,2103,2106,2110,2113,2117,//290
	2121,2124,2128,2131,2135,2138,2142,2145,2149,2153 //300
};


//(B值3380)
const U16 TempCoffAdTable_3380[] =
{
	3902, 3893, 3882, 3870, 3858, 3845, 3832, 3818, 3805, 3791,
	3774, 3758, 3741, 3722, 3706, 3686, 3669, 3649, 3626, 3607,
	3586, 3563, 3540, 3513, 3491, 3466, 3436, 3410, 3382, 3354,
	3326, 3299, 3270, 3239, 3204, 3172, 3140, 3107, 3073, 3038,
	3004, 2969, 2937, 2901, 2864, 2827, 2790, 2749, 2714, 2672,
	2637, 2596, 2559, 2516, 2477, 2438, 2401, 2358, 2323, 2284,
	2240, 2204, 2161, 2125, 2084, 2048, 2010, 1968, 1933, 1893,
	1857, 1822, 1786, 1746, 1713, 1674, 1642, 1605, 1571, 1538,
	1504, 1472, 1440, 1408, 1376, 1347, 1317, 1287, 1257, 1230,
	1201, 1174, 1147, 1121, 1095, 1069, 1046, 1023, 1000, 979,
	955,  933,  911,  888,  868,  848,  827,  809,  790,  771,
	755,  736,  719,  702,  686,  668,  654,  639,  619,  604,
	589,  574,  562,  550,  537,  525,  516,  503,  494,  481,
	468,  458,  449,  436,  422,  413,  403,  393,  382,  376,
	366,  359,  349,  342,  335,  328,  321,  314,  307,  300,
	293,  286,  279,  275,  268,  261,  257,  250,  246,  239,
	235,  232,  225,  221,  217,  210,
};

//(B值3435)
const U16 TempCoffAdTable_3435[] =
{
	3904, 3894, 3882, 3871, 3858, 3846, 3832, 3819, 3804, 3789,
	3774, 3758, 3741, 3724, 3706, 3687, 3668, 3648, 3627, 3606,
	3584, 3561, 3538, 3514, 3489, 3464, 3438, 3411, 3384, 3356,
	3327, 3297, 3267, 3237, 3205, 3173, 3141, 3108, 3074, 3040,
	3008, 2970, 2934, 2898, 2862, 2825, 2787, 2750, 2712, 2674,
	2635, 2596, 2557, 2518, 2479, 2440, 2400, 2361, 2322, 2282,
	2243, 2204, 2164, 2125, 2087, 2048, 2010, 1971, 1933, 1896,
	1859, 1822, 1785, 1749, 1713, 1677, 1642, 1608, 1574, 1540,
	1507, 1474, 1442, 1410, 1379, 1348, 1318, 1288, 1259, 1230,
	1202, 1174, 1147, 1121, 1095, 1069, 1044, 1020, 996,  972,
	949,  927,  905,  883,  862,  842,  821,  802,  783,  764,
	746,  728,  710,  693,  677,  660,  645,  629,  614,  599,
	585,  571,  557,  544,  531,  519,  506,  494,  483,  471,
	460,  449,  439,  428,  418,  408,  399,  390,  381,  372,
	363,  355,  347,  339,  331,  323,  316,  309,  302,  295,
	288,  282,  275,  269,  263,  257,  252,  246,  241,  235,
	230,  225,  220,  216,  211,  206,
};

U16 HAL_TEMP_AdToTemp_PT1000(U16 TempData)
{

    U16 High = (TEMP_TABLE_SIZE_PT1000 - 1);
    U16 Low = 0;
    U16 uc16Temp = 0;
    U16 Mid = (U16)(High + Low) / 2;
    U16 Sequence = SEQ_RISING;

    U32 RValue = TempData;
    RValue = (RValue*10000)/(4096*6-RValue);

	//判断表格升降序
	if( R_Table[0] < R_Table[TEMP_TABLE_SIZE_PT1000 - 1] )
	{
		Sequence = SEQ_RISING;
		//超出量程
		if( RValue < R_Table[0] || RValue > R_Table[TEMP_TABLE_SIZE_PT1000-1] )
		{
			return 0;
		}
	}
	else
	{
		Sequence = SEQ_LOWER;
		//超出量程
		if( RValue > R_Table[0] || RValue < R_Table[TEMP_TABLE_SIZE_PT1000-1] )
		{
			return 0;
		}
	}

	//二分查找
	for(;;)
	{

		if( RValue < R_Table[Mid] )
        {
            (Sequence==SEQ_RISING)?(High = Mid):(Low = Mid);
        }

        if( RValue > R_Table[Mid] )
        {
            (Sequence==SEQ_RISING)?(Low = Mid):(High = Mid);
        }

        if( (RValue==R_Table[Mid]) || (1==High-Low) || (1==Low-High) )
        {
        	 uc16Temp = ((U16)Mid * 100);
        	 break;
        }

        Mid = (U16)(((U16)High + (U16)Low) / 2);
	}

    return  (uc16Temp/100);
}

U16 HAL_TEMP_AdToTemp_3380(U16 TempData)
{

    U16 High = (TEMP_TABLE_SIZE_3380 - 1);
    U16 Low = 0;
    U16 uc16Temp = 0;
    U16 Mid = (U16)(High + Low) / 2;
    U16 Sequence = SEQ_RISING;

	//判断表格升降序
	if( TempCoffAdTable_3380[0] < TempCoffAdTable_3380[TEMP_TABLE_SIZE_3380 - 1] )
	{
		Sequence = SEQ_RISING;
		//超出量程
		if( TempData < TempCoffAdTable_3380[0] || TempData > TempCoffAdTable_3380[TEMP_TABLE_SIZE_3380-1] )
		{
			return 0;
		}
	}
	else
	{
		Sequence = SEQ_LOWER;
		//超出量程
		if( TempData > TempCoffAdTable_3380[0] || TempData < TempCoffAdTable_3380[TEMP_TABLE_SIZE_3380-1] )
		{
			return 0;
		}
	}

	//二分查找
	for(;;)
	{

		if( TempData < TempCoffAdTable_3380[Mid] )
        {
            (Sequence==SEQ_RISING)?(High = Mid):(Low = Mid);
        }

        if( TempData > TempCoffAdTable_3380[Mid] )
        {
            (Sequence==SEQ_RISING)?(Low = Mid):(High = Mid);
        }

        if( (TempData==TempCoffAdTable_3380[Mid]) || (1==High-Low) || (1==Low-High) )
        {
        	 uc16Temp = ((U16)Mid * 100);
        	 break;
        }

        Mid = (U16)(((U16)High + (U16)Low) / 2);
	}

    return  (uc16Temp/100 + 20);	/* 偏移量为-60，这里需要从-40偏移量+20变化为-60偏移量 */
}

U16 HAL_TEMP_AdToTemp_3435(U16 TempData)
{

    U16 High = (TEMP_TABLE_SIZE_3435 - 1);
    U16 Low = 0;
    U16 uc16Temp = 0;
    U16 Mid = (U16)(High + Low) / 2;
    U16 Sequence = SEQ_RISING;

	//判断表格升降序
	if( TempCoffAdTable_3435[0] < TempCoffAdTable_3435[TEMP_TABLE_SIZE_3435 - 1] )
	{
		Sequence = SEQ_RISING;
		//超出量程
		if( TempData < TempCoffAdTable_3435[0] || TempData > TempCoffAdTable_3435[TEMP_TABLE_SIZE_3435-1] )
		{
			return 0;
		}
	}
	else
	{
		Sequence = SEQ_LOWER;
		//超出量程
		if( TempData > TempCoffAdTable_3435[0] || TempData < TempCoffAdTable_3435[TEMP_TABLE_SIZE_3435-1] )
		{
			return 0;
		}
	}

	//二分查找
	for(;;)
	{

		if( TempData < TempCoffAdTable_3435[Mid] )
        {
            (Sequence==SEQ_RISING)?(High = Mid):(Low = Mid);
        }

        if( TempData > TempCoffAdTable_3435[Mid] )
        {
            (Sequence==SEQ_RISING)?(Low = Mid):(High = Mid);
        }

        if( (TempData==TempCoffAdTable_3435[Mid]) || (1==High-Low) || (1==Low-High) )
        {
        	 uc16Temp = ((U16)Mid * 100);
        	 break;
        }

        Mid = (U16)(((U16)High + (U16)Low) / 2);
	}

    return  (uc16Temp/100 + 20);	/* 偏移量为-60，这里需要从-40偏移量+20变化为-60偏移量 */
}
